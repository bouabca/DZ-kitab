FROM node:18-alpine

WORKDIR /app

# Copy package files
COPY package*.json ./

# Install dependencies
RUN npm ci

# Copy source code
COPY . .

# Accept build arguments
ARG DATABASE_URL
ARG NEXTAUTH_SECRET
ARG CLOUDINARY_API_SECRET
ARG CLOUDINARY_API_KEY
ARG CLOUDINARY_CLOUD_NAME
ARG GOOGLE_CLIENT_SECRET
ARG GOOGLE_CLIENT_ID
ARG NEXT_PUBLIC_API_URL
ARG GeminiApiKey
ARG NEXT_SERVER_ACTIONS_ENCRYPTION_KEY

# Set environment variables for build (with fallback for DATABASE_URL)
ENV DATABASE_URL=${DATABASE_URL:-postgresql://placeholder:placeholder@localhost:5432/placeholder}
ENV NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
ENV CLOUDINARY_API_SECRET=${CLOUDINARY_API_SECRET}
ENV CLOUDINARY_API_KEY=${CLOUDINARY_API_KEY}
ENV CLOUDINARY_CLOUD_NAME=${CLOUDINARY_CLOUD_NAME}
ENV GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
ENV GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
ENV NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
ENV GeminiApiKey=${GeminiApiKey}
ENV NEXT_SERVER_ACTIONS_ENCRYPTION_KEY=${NEXT_SERVER_ACTIONS_ENCRYPTION_KEY}
ENV NEXT_TELEMETRY_DISABLED=1

# Build the application
RUN npm run build

# Expose port
EXPOSE 3000

# Start the application
CMD ["npm", "start"]